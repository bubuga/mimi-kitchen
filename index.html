<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°é¼ å¤§å¨çš„å†°ç®± | Chef Mimi's Lab v2.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;700&family=Special+Elite&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --pixel-border: #3D3D3D;
            --bg-color: #F7F7F2;
            --mint: #A3C9A8;
            --peach: #FABEBE;
            --yellow: #FDE2A4;
            --mimi-blue: #7FB3D5;
            /* å·²æ›´æ–°ä¸ºæµ…è“è‰² */
        }

        body {
            font-family: 'Special Elite', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: #3D3D3D;
            letter-spacing: 0.02em;
        }

        .pixel-border {
            border: 3px solid var(--pixel-border);
            box-shadow: 4px 4px 0px 0px rgba(61, 61, 61, 0.15);
            position: relative;
            background: white;
        }

        .pixel-button {
            border: 3px solid var(--pixel-border);
            box-shadow: 3px 3px 0px 0px var(--pixel-border);
            transition: all 0.1s;
            position: relative;
            top: 0;
            left: 0;
        }

        .pixel-button:active {
            top: 2px;
            left: 2px;
            box-shadow: 1px 1px 0px 0px var(--pixel-border);
        }

        /* æ–™ç†é¼ ç‹ç±³ç±³ IP */
        .mimi-mascot {
            width: 56px;
            height: 50px;
            background: var(--mimi-blue);
            position: relative;
            border: 3px solid var(--pixel-border);
            margin-top: 20px;
        }

        .mimi-hat {
            position: absolute;
            width: 32px;
            height: 20px;
            background: white;
            border: 3px solid var(--pixel-border);
            top: -22px;
            left: 9px;
            border-radius: 4px 4px 0 0;
        }

        .mimi-hat::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 8px;
            background: white;
            border: 3px solid var(--pixel-border);
            bottom: -3px;
            left: -7px;
        }

        .mimi-ear-l,
        .mimi-ear-r {
            position: absolute;
            width: 22px;
            height: 22px;
            background: #E98074;
            border: 3px solid var(--pixel-border);
            top: -8px;
            border-radius: 50%;
            z-index: -1;
        }

        .mimi-ear-l {
            left: -8px;
        }

        .mimi-ear-r {
            right: -8px;
        }

        .mimi-eye-l,
        .mimi-eye-r {
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            top: 12px;
        }

        .mimi-eye-l {
            left: 10px;
        }

        .mimi-eye-r {
            right: 10px;
        }

        .mimi-eye-l::after,
        .mimi-eye-r::after {
            content: '';
            position: absolute;
            width: 3px;
            height: 3px;
            background: black;
            top: 1px;
            left: 1px;
        }

        .mimi-nose {
            position: absolute;
            width: 8px;
            height: 6px;
            background: #000;
            bottom: 10px;
            left: 21px;
            border-radius: 4px;
        }

        .pixel-bubble {
            background: white;
            border: 3px solid var(--pixel-border);
            padding: 12px 20px;
            position: relative;
        }

        .pixel-bubble::after {
            content: '';
            position: absolute;
            left: -14px;
            top: 18px;
            width: 10px;
            height: 10px;
            background: white;
            border-left: 3px solid var(--pixel-border);
            border-bottom: 3px solid var(--pixel-border);
            transform: rotate(45deg);
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 280px;
            height: 200px;
            margin: 0 auto;
        }

        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 12px;
            background: #EEE;
            border: 2px solid var(--pixel-border);
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 10px;
            background: var(--pixel-border);
            margin-top: -6px;
        }

        .tabs {
            display: flex;
            border-bottom: 3px solid var(--pixel-border);
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            cursor: pointer;
            border: 3px solid transparent;
            margin-bottom: -3px;
        }

        .tab-btn.active {
            border: 3px solid var(--pixel-border);
            border-bottom-color: white;
            background: white;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .loading-pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="p-4 md:p-10">

    <div class="max-w-6xl mx-auto space-y-10">

        <!-- HEADER -->
        <header class="flex flex-col md:flex-row items-center gap-6">
            <div class="mimi-mascot flex-shrink-0 animate-bounce">
                <div class="mimi-hat"></div>
                <div class="mimi-ear-l"></div>
                <div class="mimi-ear-r"></div>
                <div class="mimi-eye-l"></div>
                <div class="mimi-eye-r"></div>
                <div class="mimi-nose"></div>
            </div>
            <div class="pixel-bubble flex-grow">
                <h1 class="text-xl font-bold tracking-widest uppercase">Chef Mimi's Kitchen.</h1>
                <p id="mimi-speech" class="text-sm mt-1 opacity-80 italic">ä½ å¥½ï¼æˆ‘æ˜¯å¤§å¨ç±³ç±³ã€‚æˆ‘ä¼šå¸®ä½ ç®¡å¥½å†°ç®±ï¼Œé¡ºä¾¿æ‰¾æ‰¾å¥½åƒçš„åšæ³•ï¼</p>
            </div>
            <div class="flex gap-3 flex-wrap">
                <button onclick="openModal('scan-modal')" class="pixel-button bg-yellow px-4 py-3 font-bold text-xs">
                    <i class="fas fa-camera mr-2"></i>æ™ºèƒ½å½•å…¥
                </button>
                <button onclick="openModal('add-modal')" class="pixel-button bg-mint px-4 py-3 font-bold text-xs">
                    <i class="fas fa-plus mr-2"></i>å¸¸è§„å…¥åº“
                </button>
                <button onclick="openModal('settings-modal')"
                    class="pixel-button bg-mimi-blue px-4 py-3 font-bold text-xs"
                    style="background-color: var(--mimi-blue);">
                    <i class="fas fa-cog mr-2"></i>è®¾ç½®
                </button>
                <button onclick="exportData()" class="pixel-button bg-stone-100 px-3 py-3 font-bold text-xs"
                    title="å¯¼å‡ºæ•°æ®å¤‡ä»½">
                    <i class="fas fa-download"></i>
                </button>
                <button onclick="document.getElementById('import-file').click()"
                    class="pixel-button bg-stone-100 px-3 py-3 font-bold text-xs" title="å¯¼å…¥æ•°æ®">
                    <i class="fas fa-upload"></i>
                </button>
                <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
            </div>
        </header>

        <!-- DASHBOARD -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 pixel-border p-6 bg-[#FEFCF9]">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold">ä¸´æœŸçœ‹æ¿ / Kanban</h2>
                    <span class="text-[10px] uppercase font-bold text-rose-500">Expiring Priority</span>
                </div>
                <div id="urgent-container" class="space-y-3 max-h-[250px] overflow-y-auto pr-2"></div>
            </div>

            <div class="pixel-border p-6 bg-white flex flex-col items-center">
                <h3 class="font-bold mb-6 text-stone-400 text-[10px] uppercase">Inventory Pulse</h3>
                <div class="chart-container"><canvas id="healthChart"></canvas></div>
                <div id="stats-display"
                    class="mt-6 grid grid-cols-3 gap-6 text-center w-full border-t-2 border-stone-50 pt-4"></div>
            </div>
        </div>

        <!-- TABS SECTION -->
        <section>
            <div class="tabs">
                <div onclick="switchTab('inventory')" id="tab-inventory" class="tab-btn active">å†°ç®±åº“å­˜</div>
                <div onclick="switchTab('cookbook')" id="tab-cookbook" class="tab-btn">ç§å®¶èœè°±åº“ (ä¼˜å…ˆ)</div>
            </div>

            <div id="content-inventory" class="space-y-6">
                <div id="inventory-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="content-cookbook" class="hidden space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">æˆ‘çš„ç§è—èœè°±</h3>
                    <button onclick="openModal('recipe-modal')"
                        class="pixel-button bg-peach px-4 py-2 text-xs font-bold">è®°å½•æ–°èœè°± +</button>
                </div>
                <div id="cookbook-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </section>

        <!-- RECIPE GENERATION -->
        <section class="pixel-border p-8 bg-stone-50 border-dashed">
            <div class="flex flex-col md:flex-row items-center gap-8 mb-10">
                <div class="text-center md:text-left">
                    <h2 class="text-2xl font-bold italic tracking-tight">Today's Menu.</h2>
                    <p class="text-stone-500 text-xs mt-2">ç‚¹å‡»ç”Ÿæˆï¼šä¼˜å…ˆæ¨èæ‚¨çš„èœè°±åº“ï¼Œå¤–éƒ¨å‚è€ƒ Cook åŠä¸‹å¨æˆ¿ã€‚</p>
                </div>
                <div class="flex-grow"></div>
                <button id="gen-btn" onclick="generateRecipes()"
                    class="pixel-button bg-stone-800 text-white px-10 py-4 font-bold tracking-widest hover:bg-black transition">
                    CHEF RECOMMEND
                </button>
            </div>

            <div id="recipe-display-area" class="space-y-10">
                <div id="urgent-recipes" class="grid grid-cols-1 md:grid-cols-2 gap-8 hidden">
                    <div class="col-span-full border-b-2 border-rose-100 pb-2 mb-2">
                        <h4 class="text-rose-500 font-bold text-sm">âœ¦ ä¸´æœŸæŠ¢æ•‘ï¼šå¿…é¡»æ¶ˆç­</h4>
                    </div>
                </div>
                <div id="general-recipes" class="grid grid-cols-1 md:grid-cols-2 gap-8 hidden">
                    <div class="col-span-full border-b-2 border-stone-200 pb-2 mb-2">
                        <h4 class="text-stone-400 font-bold text-sm">âœ¦ å…¨åº“æ¨èï¼šç¾å‘³æ­é…</h4>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- MODALS -->
    <div id="add-modal"
        class="fixed inset-0 bg-stone-900/40 hidden items-center justify-center z-50 p-6 backdrop-blur-sm">
        <div class="pixel-border bg-white p-8 w-full max-w-md">
            <h3 class="font-bold mb-6 uppercase">Manual Entry.</h3>
            <form onsubmit="handleSaveItem(event)" class="space-y-4">
                <input type="text" id="add-name" placeholder="åç§°..." required
                    class="w-full border-2 border-stone-200 p-3 outline-none">
                <div class="grid grid-cols-2 gap-4">
                    <select id="add-loc" class="w-full border-2 border-stone-200 p-3 outline-none">
                        <option value="cold">å†·è—</option>
                        <option value="frozen">å†·å†»</option>
                    </select>
                    <select id="add-cat" class="w-full border-2 border-stone-200 p-3 outline-none">
                        <option value="veg">è”¬èœ</option>
                        <option value="meat">è‚‰ç±»</option>
                        <option value="milk">å¥¶åˆ¶å“</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="add-buy" required class="w-full border-2 border-stone-200 p-2 text-xs">
                    <input type="date" id="add-exp" required class="w-full border-2 border-stone-200 p-2 text-xs">
                </div>
                <button type="submit" class="w-full pixel-button bg-stone-800 text-white py-3 font-bold">SUBMIT</button>
            </form>
            <button onclick="closeModal('add-modal')"
                class="mt-4 w-full text-stone-300 text-[10px] underline">CANCEL</button>
        </div>
    </div>

    <div id="scan-modal"
        class="fixed inset-0 bg-stone-900/40 hidden items-center justify-center z-50 p-4 backdrop-blur-sm overflow-y-auto">
        <div class="pixel-border bg-white p-6 w-full max-w-2xl my-4">
            <h3 class="font-bold mb-4 uppercase">AI Smart Scan.</h3>
            <div id="scan-input-area" class="space-y-6">
                <div class="p-4 border-2 border-dashed border-stone-300 rounded text-center">
                    <p class="text-[10px] text-stone-400 mb-2 uppercase">æ–¹å¼ 1: å›¾ç‰‡è¯†åˆ«ï¼ˆè´­ç‰©æˆªå›¾ / å†°ç®±ç…§ç‰‡ï¼‰</p>
                    <input type="file" id="image-input" accept="image/*" class="hidden" onchange="processImage(this)">
                    <button onclick="document.getElementById('image-input').click()"
                        class="pixel-button bg-stone-50 px-6 py-2 text-xs">é€‰å–ç…§ç‰‡</button>
                </div>
                <div class="relative">
                    <p class="text-[10px] text-stone-400 mb-2 uppercase text-center">æ–¹å¼ 2: æ–‡å­—è§£æ</p>
                    <textarea id="text-input" placeholder="ä¾‹: æ˜¨å¤©ä¹°äº†5ä¸ªè¥¿çº¢æŸ¿å’Œä¸€ç›’ç‰›å¥¶..."
                        class="w-full border-2 border-stone-200 p-3 h-24 text-sm outline-none"></textarea>
                    <button onclick="processText()"
                        class="w-full pixel-button bg-yellow py-3 font-bold mt-2">è§£ææ–‡å­—</button>
                </div>
            </div>

            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div id="scan-preview" class="hidden mt-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-sm">è¯†åˆ«ç»“æœ â€” è¯·ç¡®è®¤å¹¶ç¼–è¾‘</h4>
                    <button onclick="resetScan()" class="text-[10px] text-stone-400 underline">é‡æ–°æ‰«æ</button>
                </div>
                <div id="scan-preview-list" class="space-y-3 max-h-[50vh] overflow-y-auto pr-1"></div>
                <div class="flex gap-3 mt-4">
                    <button onclick="confirmScanItems()" class="flex-grow pixel-button bg-mint py-3 font-bold text-sm">âœ“
                        ç¡®è®¤æ·»åŠ é€‰ä¸­é¡¹</button>
                    <button onclick="resetScan()" class="pixel-button bg-stone-100 px-4 py-3 text-xs">å–æ¶ˆ</button>
                </div>
            </div>

            <div id="scan-status" class="mt-4 text-[10px] text-center italic text-stone-500"></div>
            <button onclick="closeModal('scan-modal'); resetScan();"
                class="mt-4 w-full text-stone-300 text-[10px] underline">CLOSE</button>
        </div>
    </div>

    <div id="recipe-modal"
        class="fixed inset-0 bg-stone-900/40 hidden items-center justify-center z-50 p-6 backdrop-blur-sm">
        <div class="pixel-border bg-white p-8 w-full max-w-lg">
            <h3 class="font-bold mb-6 uppercase">Save Recipe.</h3>
            <form onsubmit="handleSaveRecipe(event)" class="space-y-4">
                <input type="text" id="rec-title" placeholder="èœè°±åç§°..." required
                    class="w-full border-2 border-stone-200 p-3 outline-none">
                <textarea id="rec-ings" placeholder="æ‰€éœ€ä¸»è¦é£Ÿæ..." required
                    class="w-full border-2 border-stone-200 p-3 h-20 text-sm outline-none"></textarea>
                <textarea id="rec-steps" placeholder="çƒ¹é¥ªè¯¦ç»†æ­¥éª¤..." required
                    class="w-full border-2 border-stone-200 p-3 h-32 text-sm outline-none"></textarea>
                <button type="submit" class="w-full pixel-button bg-peach py-3 font-bold">SAVE TO BOOK</button>
            </form>
            <button onclick="closeModal('recipe-modal')"
                class="mt-4 w-full text-stone-300 text-[10px] underline">CANCEL</button>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal"
        class="fixed inset-0 bg-stone-900/40 hidden items-center justify-center z-50 p-6 backdrop-blur-sm">
        <div class="pixel-border bg-white p-8 w-full max-w-md">
            <h3 class="font-bold mb-6 uppercase">Settings / è®¾ç½®</h3>
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] uppercase font-bold text-stone-400 block mb-2">å®¶åº­ç  / Household
                        Code</label>
                    <p class="text-[9px] text-stone-400 mb-2">åœ¨æ‰€æœ‰è®¾å¤‡è¾“å…¥ç›¸åŒçš„å®¶åº­ç å³å¯åŒæ­¥æ•°æ®</p>
                    <input type="text" id="settings-household" placeholder="ä¾‹å¦‚: mimi-home-2024"
                        class="w-full border-2 border-stone-200 p-3 outline-none text-sm">
                </div>
                <div class="border-t border-stone-100 pt-4">
                    <label class="text-[10px] uppercase font-bold text-stone-400 block mb-2">Gemini API Key</label>
                    <p class="text-[9px] text-stone-400 mb-2">ä» <a href="https://aistudio.google.com/apikey"
                            target="_blank" class="underline text-blue-500">Google AI Studio</a> è·å–å…è´¹çš„ API Key</p>
                    <div class="flex gap-2">
                        <input type="password" id="settings-apikey" placeholder="ç²˜è´´ä½ çš„ API Key..."
                            class="flex-grow border-2 border-stone-200 p-3 outline-none text-sm">
                        <button onclick="toggleApiKeyVisibility()" class="pixel-button bg-stone-100 px-3 py-2 text-xs">
                            <i id="apikey-eye" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="border-t border-stone-100 pt-4">
                    <label class="text-[10px] uppercase font-bold text-stone-400 block mb-2">AI æ¨¡å‹</label>
                    <select id="settings-model" class="w-full border-2 border-stone-200 p-3 outline-none text-sm">
                        <option value="gemini-3-flash-preview" selected>Gemini 3 Flash Preview</option>
                    </select>
                </div>
                <div class="border-t border-stone-100 pt-4">
                    <label class="text-[10px] uppercase font-bold text-stone-400 block mb-2">æ•°æ®ç®¡ç†</label>
                    <div class="flex gap-3">
                        <button onclick="clearAllData()"
                            class="pixel-button bg-rose-100 px-4 py-2 text-xs font-bold text-rose-600">
                            <i class="fas fa-trash-alt mr-1"></i>æ¸…ç©ºæ‰€æœ‰æ•°æ®
                        </button>
                    </div>
                    <p class="text-[8px] text-stone-300 mt-2">æ¸…ç©ºå‰å»ºè®®å…ˆç”¨å¯¼å‡ºæŒ‰é’®å¤‡ä»½æ•°æ®ã€‚</p>
                </div>
            </div>
            <button onclick="saveSettings()"
                class="mt-6 w-full pixel-button bg-stone-800 text-white py-3 font-bold">ä¿å­˜è®¾ç½®</button>
            <button onclick="closeModal('settings-modal')"
                class="mt-3 w-full text-stone-300 text-[10px] underline">CANCEL</button>
        </div>
    </div>

    <script>
        // === Supabase é…ç½® ===
        const SUPABASE_URL = 'https://yeglyiexqhfwffptbjhh.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_XqDbZTpGyIueVBpFr2p8Iw__xn-elMo';
        let sb = null; // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç­‰ CDN åŠ è½½å®Œæˆ

        const STORAGE_KEYS = {
            API_KEY: 'mimi_api_key',
            MODEL: 'mimi_model',
            HOUSEHOLD: 'mimi_household'
        };

        let apiKey = '';
        let selectedModel = 'gemini-3-flash-preview';
        let householdId = '';
        let inventory = [];
        let userRecipes = [];
        let currentTab = 'inventory';
        let mainChart = null;

        // === äº‘ç«¯æ•°æ®æ“ä½œ ===
        async function loadDataFromCloud() {
            if (!householdId) return;
            try {
                console.log('[Mimi] ä»äº‘ç«¯åŠ è½½æ•°æ®, å®¶åº­ç :', householdId);
                const { data: inv, error: e1 } = await sb
                    .from('inventory').select('*')
                    .eq('household_id', householdId).order('created_at', { ascending: false });
                if (e1) throw e1;
                inventory = (inv || []).map(i => ({
                    id: i.id, name: i.name, loc: i.loc, cat: i.cat,
                    buy: i.buy, exp: i.exp, qty: i.qty
                }));

                const { data: rec, error: e2 } = await sb
                    .from('recipes').select('*')
                    .eq('household_id', householdId).order('created_at', { ascending: false });
                if (e2) throw e2;
                userRecipes = (rec || []).map(r => ({
                    id: r.id, title: r.title, ingredients: r.ingredients, steps: r.steps
                }));

                console.log(`[Mimi] äº‘ç«¯åŠ è½½å®Œæˆ: ${inventory.length} é£Ÿæ, ${userRecipes.length} èœè°±`);
                renderAll();
            } catch (e) {
                console.error('[Mimi] äº‘ç«¯åŠ è½½å¤±è´¥:', e.message);
            }
        }

        async function addItemToCloud(item) {
            if (!householdId) return item;
            try {
                const { data, error } = await sb.from('inventory').insert({
                    household_id: householdId, name: item.name, loc: item.loc,
                    cat: item.cat, buy: item.buy, exp: item.exp, qty: item.qty
                }).select().single();
                if (error) throw error;
                return { id: data.id, name: data.name, loc: data.loc, cat: data.cat, buy: data.buy, exp: data.exp, qty: data.qty };
            } catch (e) { console.error('[Mimi] æ·»åŠ é£Ÿæåˆ°äº‘ç«¯å¤±è´¥:', e.message); return item; }
        }

        async function updateItemInCloud(id, updates) {
            if (!householdId) return;
            try {
                await sb.from('inventory').update(updates).eq('id', id);
            } catch (e) { console.error('[Mimi] æ›´æ–°å¤±è´¥:', e.message); }
        }

        async function deleteItemFromCloud(id) {
            if (!householdId) return;
            try {
                await sb.from('inventory').delete().eq('id', id);
            } catch (e) { console.error('[Mimi] åˆ é™¤å¤±è´¥:', e.message); }
        }

        async function addRecipeToCloud(recipe) {
            if (!householdId) return recipe;
            try {
                const { data, error } = await sb.from('recipes').insert({
                    household_id: householdId, title: recipe.title,
                    ingredients: recipe.ingredients, steps: recipe.steps
                }).select().single();
                if (error) throw error;
                return { id: data.id, title: data.title, ingredients: data.ingredients, steps: data.steps };
            } catch (e) { console.error('[Mimi] æ·»åŠ èœè°±åˆ°äº‘ç«¯å¤±è´¥:', e.message); return recipe; }
        }

        async function deleteRecipeFromCloud(id) {
            if (!householdId) return;
            try {
                await sb.from('recipes').delete().eq('id', id);
            } catch (e) { console.error('[Mimi] åˆ é™¤èœè°±å¤±è´¥:', e.message); }
        }

        async function clearAllDataFromCloud() {
            if (!householdId) return;
            try {
                await sb.from('inventory').delete().eq('household_id', householdId);
                await sb.from('recipes').delete().eq('household_id', householdId);
            } catch (e) { console.error('[Mimi] æ¸…ç©ºäº‘ç«¯æ•°æ®å¤±è´¥:', e.message); }
        }

        // === æœ¬åœ°è®¾ç½® ===
        function loadLocalSettings() {
            apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY) || '';
            selectedModel = localStorage.getItem(STORAGE_KEYS.MODEL) || 'gemini-3-flash-preview';
            householdId = localStorage.getItem(STORAGE_KEYS.HOUSEHOLD) || '';
        }

        async function saveSettings() {
            apiKey = document.getElementById('settings-apikey').value.trim();
            selectedModel = document.getElementById('settings-model').value;
            const newHousehold = document.getElementById('settings-household').value.trim();
            localStorage.setItem(STORAGE_KEYS.API_KEY, apiKey);
            localStorage.setItem(STORAGE_KEYS.MODEL, selectedModel);
            const householdChanged = newHousehold !== householdId;
            householdId = newHousehold;
            localStorage.setItem(STORAGE_KEYS.HOUSEHOLD, householdId);
            closeModal('settings-modal');
            if (householdChanged && householdId) {
                await loadDataFromCloud();
            }
            updateMimi();
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('settings-apikey');
            const icon = document.getElementById('apikey-eye');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function exportData() {
            const data = { inventory, recipes: userRecipes, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mimi_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function importData(input) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = async () => {
                try {
                    const data = JSON.parse(reader.result);
                    if (data.inventory && householdId) {
                        for (const item of data.inventory) {
                            const saved = await addItemToCloud(item);
                            inventory.push(saved);
                        }
                    }
                    if (data.recipes && householdId) {
                        for (const r of data.recipes) {
                            const saved = await addRecipeToCloud(r);
                            userRecipes.push(saved);
                        }
                    }
                    renderAll();
                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                } catch (e) { alert('å¯¼å…¥å¤±è´¥: ' + e.message); }
            };
            reader.readAsText(input.files[0]);
            input.value = '';
        }

        async function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ï¼')) return;
            if (!confirm('å†æ¬¡ç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰é£Ÿæå’Œèœè°±æ•°æ®ï¼Œä¸å¯æ¢å¤ï¼')) return;
            await clearAllDataFromCloud();
            inventory = [];
            userRecipes = [];
            renderAll();
        }

        function getDays(expStr) {
            const diff = new Date(expStr) - new Date().setHours(0, 0, 0, 0);
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }

        function extractJson(str) {
            if (!str) throw new Error('Empty response');
            // å»é™¤ markdown ä»£ç å—æ ‡è®° (```json ... ```)
            let cleaned = str.replace(/```(?:json)?\s*/gi, '').replace(/```\s*/g, '');
            try {
                const first = Math.min(cleaned.indexOf('{') === -1 ? Infinity : cleaned.indexOf('{'), cleaned.indexOf('[') === -1 ? Infinity : cleaned.indexOf('['));
                const last = Math.max(cleaned.lastIndexOf('}'), cleaned.lastIndexOf(']'));
                if (first === Infinity || last === -1) throw new Error('No JSON found in response');
                return JSON.parse(cleaned.slice(first, last + 1));
            } catch (e) {
                console.error('JSON è§£æå¤±è´¥, åŸå§‹å“åº”:', str);
                throw e;
            }
        }

        async function geminiCall(prompt, imageData = null) {
            if (!apiKey) {
                alert('è¯·å…ˆåœ¨ã€Œè®¾ç½®ã€ä¸­é…ç½® Gemini API Keyï¼\n\nå¯ä» https://aistudio.google.com/apikey å…è´¹è·å–ã€‚');
                openModal('settings-modal');
                return null;
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
            const requestBody = {
                contents: [{ parts: [{ text: prompt }] }]
            };
            if (imageData) requestBody.contents[0].parts.push({ inlineData: { mimeType: "image/png", data: imageData } });

            const maxRetries = 2;
            let lastError = '';
            for (let i = 0; i < maxRetries; i++) {
                try {
                    console.log(`[Mimi] API è°ƒç”¨ä¸­... æ¨¡å‹: ${selectedModel}, å°è¯• ${i + 1}/${maxRetries}`);
                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (!resp.ok) {
                        const errData = await resp.json().catch(() => ({}));
                        const errMsg = errData.error?.message || resp.statusText;
                        console.error(`[Mimi] API é”™è¯¯ (${resp.status}):`, errMsg);
                        lastError = `${resp.status}: ${errMsg}`;

                        // Auth/key errors - don't retry
                        if (resp.status === 401 || resp.status === 403) {
                            alert(`API Key æ— æ•ˆ (${resp.status})\n\n${errMsg}\n\nè¯·æ£€æŸ¥ã€Œè®¾ç½®ã€ä¸­çš„ API Keyã€‚`);
                            openModal('settings-modal');
                            return null;
                        }
                        // Model not found
                        if (resp.status === 404) {
                            alert(`æ¨¡å‹ "${selectedModel}" ä¸å­˜åœ¨\n\nè¯·åœ¨ã€Œè®¾ç½®ã€ä¸­åˆ‡æ¢å…¶ä»–æ¨¡å‹ã€‚`);
                            openModal('settings-modal');
                            return null;
                        }
                        // Rate limit or other - retry
                        if (i < maxRetries - 1) {
                            await new Promise(r => setTimeout(r, 2000));
                            continue;
                        }
                        break;
                    }

                    const data = await resp.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    console.log('[Mimi] API å“åº”æˆåŠŸ, é•¿åº¦:', text?.length);
                    return text;
                } catch (e) {
                    lastError = e.message;
                    console.error(`[Mimi] ç½‘ç»œè¯·æ±‚å¤±è´¥ (å°è¯• ${i + 1}):`, e.message);
                    if (i < maxRetries - 1) {
                        await new Promise(r => setTimeout(r, 2000));
                    }
                }
            }
            alert(`API è¯·æ±‚å¤±è´¥\n\né”™è¯¯è¯¦æƒ…: ${lastError}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åœ¨ã€Œè®¾ç½®ã€ä¸­åˆ‡æ¢æ¨¡å‹åé‡è¯•ã€‚`);
            return null;
        }

        let pendingScanItems = []; // AI è¯†åˆ«åçš„å¾…ç¡®è®¤åˆ—è¡¨

        async function processText() {
            const text = document.getElementById('text-input').value;
            if (!text) return;
            document.getElementById('scan-status').innerText = "ç±³ç±³æ­£åœ¨é˜…è¯»...";
            const today = new Date().toISOString().split('T')[0];
            const prompt = `ä½ æ˜¯ä¸€ä¸ªå†°ç®±ç®¡å®¶ï¼Œä»æ–‡å­—ä¸­è¯†åˆ«é£Ÿæã€‚ä»Šå¤©æ—¥æœŸæ˜¯ ${today}ã€‚
æ‰€æœ‰é£Ÿæåç§°å¿…é¡»ä½¿ç”¨ä¸­æ–‡ã€‚å¦‚æœåŸæ–‡æ˜¯è‹±æ–‡ï¼Œè¯·ç¿»è¯‘æˆä¸­æ–‡ã€‚
ä»…è¾“å‡º JSON æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
- name: é£Ÿæåç§°ï¼ˆä¸­æ–‡ï¼‰
- loc: å­˜å‚¨ä½ç½®ï¼Œ"cold"(å†·è—) æˆ– "frozen"(å†·å†»)
- cat: åˆ†ç±»ï¼Œ"veg"(è”¬èœæ°´æœ) æˆ– "meat"(è‚‰ç±») æˆ– "milk"(å¥¶åˆ¶å“) æˆ– "other"(å…¶ä»–)
- buy: è´­ä¹°æ—¥æœŸï¼ŒYYYY-MM-DD æ ¼å¼
- exp: é¢„è®¡è¿‡æœŸæ—¥æœŸï¼ŒYYYY-MM-DD æ ¼å¼ï¼ˆæ ¹æ®é£Ÿæç±»å‹åˆç†æ¨æ–­ï¼‰
ç¤ºä¾‹: [{"name":"è¥¿çº¢æŸ¿","loc":"cold","cat":"veg","buy":"2024-01-01","exp":"2024-01-06"}]
æ–‡å­—å†…å®¹ï¼š${text}`;
            const result = await geminiCall(prompt);
            handleAiResult(result);
        }

        async function processImage(input) {
            if (!input.files[0]) return;
            document.getElementById('scan-status').innerText = "ç±³ç±³æ­£åœ¨æ‰«æå›¾ç‰‡...";
            const reader = new FileReader();
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                const today = new Date().toISOString().split('T')[0];
                const prompt = `è¯†åˆ«å›¾ä¸­æ‰€æœ‰é£Ÿææˆ–é£Ÿå“ï¼Œä»Šå¤©æ˜¯ ${today}ã€‚
æ‰€æœ‰åç§°å¿…é¡»ç¿»è¯‘æˆä¸­æ–‡ã€‚
ä»…è¾“å‡º JSON æ•°ç»„ï¼Œå­—æ®µ:
- name: é£Ÿæåç§°ï¼ˆä¸­æ–‡ï¼‰
- loc: "cold" æˆ– "frozen"
- cat: "veg"(è”¬èœæ°´æœ) / "meat"(è‚‰ç±») / "milk"(å¥¶åˆ¶å“) / "other"(å…¶ä»–ï¼ŒåŒ…æ‹¬é¢ç²‰ã€é¢åŒ…ç­‰)
- buy: è´­ä¹°æ—¥æœŸ YYYY-MM-DD
- exp: é¢„è®¡è¿‡æœŸæ—¥æœŸ YYYY-MM-DDï¼ˆæ ¹æ®é£Ÿæç±»å‹åˆç†æ¨æ–­ä¿è´¨æœŸï¼‰`;
                const result = await geminiCall(prompt, base64);
                handleAiResult(result);
            };
            reader.readAsDataURL(input.files[0]);
        }

        function handleAiResult(rawText) {
            try {
                const newItems = extractJson(rawText);
                if (!Array.isArray(newItems) || newItems.length === 0) {
                    document.getElementById('scan-status').innerText = "æœªè¯†åˆ«åˆ°é£Ÿæï¼Œè¯·é‡è¯•ã€‚";
                    return;
                }
                const today = new Date().toISOString().split('T')[0];
                const weekLater = new Date(Date.now() + 86400000 * 7).toISOString().split('T')[0];

                // å­—æ®µæ˜ å°„ + è§„èŒƒåŒ–
                pendingScanItems = newItems.map((item, i) => {
                    let cat = item.cat || item.category || item.åˆ†ç±» || 'other';
                    if (!['veg', 'meat', 'milk', 'other'].includes(cat)) {
                        cat = cat.includes('è‚‰') ? 'meat' : cat.includes('å¥¶') ? 'milk' : cat.includes('èœ') || cat.includes('æœ') ? 'veg' : 'other';
                    }
                    return {
                        checked: true,
                        name: item.name || item.åç§° || 'æœªçŸ¥é£Ÿæ',
                        loc: item.loc || item.location || 'cold',
                        cat: cat,
                        buy: item.buy || item.buyDate || item.è´­ä¹°æ—¥æœŸ || today,
                        exp: item.exp || item.expiryDate || item.è¿‡æœŸæ—¥æœŸ || weekLater
                    };
                });

                renderScanPreview();
            } catch (e) {
                console.error('[Mimi] AI è§£æå¤±è´¥:', e);
                document.getElementById('scan-status').innerText = "è§£æå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚";
            }
        }

        function renderScanPreview() {
            document.getElementById('scan-input-area').classList.add('hidden');
            document.getElementById('scan-preview').classList.remove('hidden');
            document.getElementById('scan-status').innerText = `è¯†åˆ«åˆ° ${pendingScanItems.length} ä¸ªé£Ÿæï¼Œè¯·ç¡®è®¤åæ·»åŠ `;

            const catLabels = { veg: 'ğŸ¥¦ è”¬æœ', meat: 'ğŸ¥© è‚‰ç±»', milk: 'ğŸ¥› å¥¶å“', other: 'ğŸ“¦ å…¶ä»–' };
            const locLabels = { cold: 'â„ï¸ å†·è—', frozen: 'ğŸ§Š å†·å†»' };

            const list = document.getElementById('scan-preview-list');
            list.innerHTML = pendingScanItems.map((item, i) => `
                <div class="border-2 ${item.checked ? 'border-stone-300' : 'border-stone-100 opacity-50'} rounded p-3 bg-stone-50 transition-all" id="scan-item-${i}">
                    <div class="flex items-center gap-2 mb-2">
                        <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleScanItem(${i}, this.checked)" class="w-4 h-4 accent-emerald-500">
                        <input type="text" value="${item.name}" id="scan-name-${i}" class="flex-grow font-bold text-sm border-b border-stone-300 bg-transparent outline-none px-1 py-0.5">
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-[11px]">
                        <div>
                            <label class="text-stone-400 block mb-0.5">åˆ†ç±»</label>
                            <select id="scan-cat-${i}" class="w-full border border-stone-200 rounded px-2 py-1 bg-white text-xs">
                                ${Object.entries(catLabels).map(([k, v]) => `<option value="${k}" ${item.cat === k ? 'selected' : ''}>${v}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="text-stone-400 block mb-0.5">å­˜å‚¨</label>
                            <select id="scan-loc-${i}" class="w-full border border-stone-200 rounded px-2 py-1 bg-white text-xs">
                                ${Object.entries(locLabels).map(([k, v]) => `<option value="${k}" ${item.loc === k ? 'selected' : ''}>${v}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="text-stone-400 block mb-0.5">è´­ä¹°æ—¥æœŸ</label>
                            <input type="date" value="${item.buy}" id="scan-buy-${i}" class="w-full border border-stone-200 rounded px-2 py-1 bg-white text-xs">
                        </div>
                        <div>
                            <label class="text-stone-400 block mb-0.5">è¿‡æœŸæ—¥æœŸ</label>
                            <input type="date" value="${item.exp}" id="scan-exp-${i}" class="w-full border border-stone-200 rounded px-2 py-1 bg-white text-xs">
                        </div>
                    </div>
                </div>`).join('');
        }

        function toggleScanItem(index, checked) {
            pendingScanItems[index].checked = checked;
            const el = document.getElementById(`scan-item-${index}`);
            if (el) {
                el.classList.toggle('border-stone-300', checked);
                el.classList.toggle('border-stone-100', !checked);
                el.classList.toggle('opacity-50', !checked);
            }
        }

        async function confirmScanItems() {
            const selected = pendingScanItems.filter((_, i) => {
                const cb = document.querySelector(`#scan-item-${i} input[type="checkbox"]`);
                return cb && cb.checked;
            });
            if (selected.length === 0) { document.getElementById('scan-status').innerText = "è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé£Ÿæ"; return; }

            document.getElementById('scan-status').innerText = "æ­£åœ¨ä¿å­˜...";
            let count = 0;
            for (let i = 0; i < pendingScanItems.length; i++) {
                const cb = document.querySelector(`#scan-item-${i} input[type="checkbox"]`);
                if (!cb || !cb.checked) continue;
                const item = {
                    name: document.getElementById(`scan-name-${i}`).value,
                    cat: document.getElementById(`scan-cat-${i}`).value,
                    loc: document.getElementById(`scan-loc-${i}`).value,
                    buy: document.getElementById(`scan-buy-${i}`).value,
                    exp: document.getElementById(`scan-exp-${i}`).value,
                    qty: 100
                };
                const saved = await addItemToCloud(item);
                inventory.push(saved);
                count++;
            }
            document.getElementById('scan-status').innerText = `âœ“ å·²æ·»åŠ  ${count} ä¸ªé£Ÿæï¼`;
            setTimeout(() => { closeModal('scan-modal'); resetScan(); renderAll(); }, 1200);
        }

        function resetScan() {
            pendingScanItems = [];
            document.getElementById('scan-input-area').classList.remove('hidden');
            document.getElementById('scan-preview').classList.add('hidden');
            document.getElementById('scan-preview-list').innerHTML = '';
            document.getElementById('scan-status').innerText = '';
            const fileInput = document.getElementById('image-input');
            if (fileInput) fileInput.value = '';
        }

        // --- Recipe Generation ---
        async function generateRecipes() {
            const btn = document.getElementById('gen-btn');
            btn.disabled = true;
            btn.innerText = "CHEF IS COOKING...";

            try {
                const urgentItems = inventory.filter(i => getDays(i.exp) <= 3 && i.qty > 0).map(i => i.name).join(',');
                const allItems = inventory.filter(i => i.qty > 0).map(i => i.name).join(',');

                if (!allItems) {
                    alert('å†°ç®±é‡Œæ²¡æœ‰é£Ÿæï¼Œè¯·å…ˆæ·»åŠ ä¸€äº›é£Ÿæå†ç”Ÿæˆèœè°±ï¼');
                    return;
                }

                const cookbookCtx = userRecipes.length > 0 ? userRecipes.map(r => `[èœå: ${r.title}, é£Ÿæ: ${r.ingredients}]`).join('\n') : "æ— ";

                const prompt = `ä½ ç°åœ¨æ˜¯é¡¶çº§å¤§å¨ç±³ç±³ã€‚
å†°ç®±ç°æœ‰é£Ÿæï¼š${allItems}
ä¸´æœŸéœ€æ¶ˆè€—é£Ÿæï¼š${urgentItems || 'æ— '}
ç§å®¶èœè°±åº“ï¼š${cookbookCtx}

ä»»åŠ¡è¦æ±‚ï¼š
1. ä¼˜å…ˆä»ç§å®¶åº“åŒ¹é…ã€‚
2. å¯¹äºéç§å®¶èœè°±ï¼Œè¯·ç”Ÿæˆæå…¶è¯¦ç»†çš„çƒ¹é¥ªæ­¥éª¤ã€‚
3. æä¾›è¯¥èœè°±çš„å…·ä½“æœç´¢é“¾æ¥è·³è½¬åˆ°ä¸‹å¨æˆ¿ï¼šhttps://www.xiachufang.com/search/?keyword=[èœå]
4. ä¸¥æ ¼è¿”å›ä»¥ä¸‹ JSON æ ¼å¼ï¼ˆä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ï¼‰ï¼š
{ "urgent": [{"title": "èœå", "desc": "ç®€ä»‹", "steps": ["æ­¥éª¤1", "æ­¥éª¤2"], "fromCookbook": false, "detailLink": "é“¾æ¥"}], "general": [{"title": "èœå", "desc": "ç®€ä»‹", "steps": ["æ­¥éª¤1", "æ­¥éª¤2"], "fromCookbook": false, "detailLink": "é“¾æ¥"}] }`;

                const result = await geminiCall(prompt);

                if (!result) {
                    // geminiCall already showed alert if needed
                    return;
                }

                const data = extractJson(result);
                renderRecipeResults(data);
            } catch (e) {
                console.error('[Mimi] èœè°±ç”Ÿæˆå¤±è´¥:', e);
                document.getElementById('urgent-recipes').innerHTML = '<div class="col-span-full text-rose-500 p-4">ç”Ÿæˆå‡ºé”™ï¼š' + e.message + '</div>';
                document.getElementById('urgent-recipes').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerText = "CHEF RECOMMEND";
            }
        }

        function renderRecipeResults(data) {
            const urgentDiv = document.getElementById('urgent-recipes');
            const generalDiv = document.getElementById('general-recipes');

            const renderCard = (r, isUrgent) => {
                // ç¡®ä¿è·³è½¬é“¾æ¥å§‹ç»ˆæœ‰æ•ˆï¼Œä¼˜å…ˆçº§ï¼šAIç”Ÿæˆçš„detailLink > ä¸‹å¨æˆ¿æœç´¢
                const searchLink = r.detailLink || `https://www.xiachufang.com/search/?keyword=${encodeURIComponent(r.title)}`;
                const cookLink = `https://cook.zhangjc.tech/?ingredients=${encodeURIComponent(r.title)}`;

                return `
                <div class="pixel-border p-6 ${isUrgent ? 'bg-rose-50' : 'bg-white'} flex flex-col h-full">
                    <div class="flex justify-between items-start mb-3">
                        <h5 class="font-bold text-lg">/ ${r.title}</h5>
                        ${r.fromCookbook ? '<span class="text-[8px] bg-peach px-2 py-0.5 font-bold">ç§å®¶ç§˜ç±</span>' : '<span class="text-[8px] bg-stone-100 px-2 py-0.5 font-bold">ç±³ç±³å¤§å¨</span>'}
                    </div>
                    <p class="text-[11px] text-stone-400 mb-4 line-clamp-2">${r.desc || 'ç¾å‘³çƒ¹é¥ªæ¨èã€‚'}</p>
                    <div class="space-y-2 border-l-2 border-stone-800 pl-3 flex-grow mb-6">
                        ${(r.steps || []).map((s, idx) => `<div class="text-[10px] leading-relaxed"><span class="font-bold">#${idx + 1}</span> ${s}</div>`).join('')}
                    </div>
                    
                    ${!r.fromCookbook ? `
                    <div class="flex flex-col gap-3 border-t border-stone-100 pt-4">
                        <a href="${searchLink}" target="_blank" class="flex items-center text-[10px] text-blue-600 font-bold underline uppercase tracking-widest hover:text-blue-800">
                            <i class="fas fa-external-link-alt mr-2"></i> æŸ¥çœ‹å…·ä½“èœè°±æ­¥éª¤ â†’
                        </a>
                        <a href="${cookLink}" target="_blank" class="text-[8px] text-stone-400 underline hover:text-stone-600">
                            åœ¨ Cook å¹³å°æŸ¥çœ‹é£Ÿæç»„åˆ
                        </a>
                    </div>
                    ` : '<div class="text-[9px] text-stone-400 italic">æ¥è‡ªæ‚¨çš„ç§å®¶ç§˜ç±åº“ã€‚</div>'}
                </div>
            `};

            urgentDiv.innerHTML = '<div class="col-span-full border-b-2 border-rose-100 pb-2 mb-2"><h4 class="text-rose-500 font-bold text-sm">âœ¦ ä¸´æœŸæŠ¢æ•‘</h4></div>' + (data.urgent || []).map(r => renderCard(r, true)).join('');
            generalDiv.innerHTML = '<div class="col-span-full border-b-2 border-stone-200 pb-2 mb-2"><h4 class="text-stone-400 font-bold text-sm">âœ¦ å¤§å¨æ¨è</h4></div>' + (data.general || []).map(r => renderCard(r, false)).join('');
            urgentDiv.classList.remove('hidden'); generalDiv.classList.remove('hidden');
        }

        // --- Core UI & Logic ---
        function renderAll() { renderInventory(); renderUrgent(); renderStats(); renderCookbook(); updateMimi(); }

        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = inventory.filter(i => i.qty > 0).map(i => `
                <div class="pixel-border p-4 bg-white">
                    <div class="flex justify-between mb-3">
                        <h4 class="font-bold text-sm">${i.name}</h4>
                        <span class="text-[8px] bg-stone-800 text-white px-2 py-1">${(i.loc || 'cold').toUpperCase()}</span>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-[9px] font-bold">
                            <span>STOCK / ${i.qty}%</span>
                            <span class="${getDays(i.exp) <= 3 ? 'text-rose-500' : ''}">EXP / ${getDays(i.exp)}D</span>
                        </div>
                        <input type="range" value="${i.qty}" min="0" max="100" step="10" class="w-full" oninput="updateQty(${i.id}, this.value)">
                    </div>
                    <div class="mt-4 pt-2 border-t border-stone-50 flex justify-between">
                        <span class="text-[8px] text-stone-300">EXP: ${i.exp}</span>
                        <button onclick="removeItem(${i.id})" class="text-stone-200 hover:text-rose-500"><i class="fas fa-trash-alt text-[10px]"></i></button>
                    </div>
                </div>`).join('');
        }

        function renderUrgent() {
            const itemsUrgent = inventory.filter(i => getDays(i.exp) <= 3 && i.qty > 0).sort((a, b) => getDays(a.exp) - getDays(b.exp));
            const container = document.getElementById('urgent-container');
            if (itemsUrgent.length === 0) { container.innerHTML = `<div class="text-center py-10 text-stone-300 text-[10px]">å†°ç®±ç›®å‰å¾ˆæ–°é²œå®‰å…¨ã€‚</div>`; return; }
            container.innerHTML = itemsUrgent.map(i => `
                <div class="border-b border-stone-100 py-2 flex justify-between items-center bg-white px-2">
                    <div class="flex items-center gap-3">
                        <span class="text-sm">${i.cat === 'veg' ? 'ğŸ¥¦' : (i.cat === 'meat' ? 'ğŸ¥©' : 'ğŸ')}</span>
                        <div class="text-[10px] font-bold">${i.name}</div>
                    </div>
                    <div class="text-[9px] font-bold ${getDays(i.exp) < 0 ? 'text-rose-500' : 'text-amber-500'}">
                        ${getDays(i.exp) < 0 ? 'å·²è¿‡æœŸ' : 'å‰© ' + getDays(i.exp) + ' å¤©'}
                    </div>
                </div>`).join('');
        }

        function renderStats() {
            const fresh = inventory.filter(i => getDays(i.exp) > 3 && i.qty > 0).length;
            const soon = inventory.filter(i => getDays(i.exp) <= 3 && getDays(i.exp) >= 0 && i.qty > 0).length;
            const exp = inventory.filter(i => getDays(i.exp) < 0 && i.qty > 0).length;
            document.getElementById('stats-display').innerHTML = `
                <div class="text-[10px]"><span class="block text-emerald-500 font-bold text-sm">${fresh}</span>FRESH</div>
                <div class="text-[10px]"><span class="block text-amber-500 font-bold text-sm">${soon}</span>WARN</div>
                <div class="text-[10px]"><span class="block text-rose-500 font-bold text-sm">${exp}</span>EXP</div>`;
            const ctx = document.getElementById('healthChart').getContext('2d');
            if (mainChart) mainChart.destroy();
            mainChart = new Chart(ctx, {
                type: 'doughnut',
                data: { datasets: [{ data: [fresh, soon, exp], backgroundColor: ['#A3C9A8', '#FDE2A4', '#FABEBE'], borderWidth: 2, borderColor: '#3D3D3D' }] },
                options: { responsive: true, cutout: '75%', plugins: { legend: { display: false } } }
            });
        }

        function renderCookbook() {
            const grid = document.getElementById('cookbook-grid');
            if (userRecipes.length === 0) { grid.innerHTML = `<div class="col-span-full text-center py-20 text-stone-300 text-xs">ä¹¦æ¶è¿˜æ˜¯ç©ºçš„ï¼Œå¿«è®°å½•ä½ çš„æ‹¿æ‰‹å¥½èœã€‚</div>`; return; }
            grid.innerHTML = userRecipes.map(r => `
                <div class="pixel-border p-6 bg-white">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold">âœ¦ ${r.title}</h4>
                        <button onclick="removeRecipe(${r.id})" class="text-stone-200 hover:text-rose-500"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <p class="text-[10px] text-stone-500 mb-2">${r.ingredients}</p>
                    <p class="text-[11px] leading-relaxed line-clamp-2">${r.steps}</p>
                </div>`).join('');
        }

        function updateMimi() {
            const urgentCount = inventory.filter(i => getDays(i.exp) <= 3 && i.qty > 0).length;
            const speech = document.getElementById('mimi-speech');
            if (speech) speech.innerText = urgentCount > 0 ? `å±å±ï¼æœ‰ ${urgentCount} ä»¶é£Ÿæå¿«åˆ°æœŸäº†ï¼Œå¿«ç”¨æ‰å®ƒä»¬ï¼` : `ä½ å¥½ï¼å¤§å¨ç±³ç±³å·²ç»å‡†å¤‡å¥½ä¸ºä½ æœåŠ¡äº†ã€‚`;
        }

        function updateQty(id, val) {
            const item = inventory.find(i => i.id == id);
            if (item) {
                item.qty = parseInt(val);
                if (item.qty === 0) {
                    if (confirm("åƒå®Œäº†å—ï¼Ÿ")) { removeItem(id); return; }
                }
                updateItemInCloud(id, { qty: item.qty });
                renderAll();
            }
        }
        async function removeItem(id) { inventory = inventory.filter(i => i.id != id); await deleteItemFromCloud(id); renderAll(); }
        async function removeRecipe(id) { userRecipes = userRecipes.filter(r => r.id != id); await deleteRecipeFromCloud(id); renderCookbook(); }
        async function handleSaveItem(e) {
            e.preventDefault();
            const newItem = { name: document.getElementById('add-name').value, loc: document.getElementById('add-loc').value, cat: document.getElementById('add-cat').value, buy: document.getElementById('add-buy').value, exp: document.getElementById('add-exp').value, qty: 100 };
            const saved = await addItemToCloud(newItem);
            inventory.push(saved);
            closeModal('add-modal'); renderAll(); e.target.reset();
        }
        async function handleSaveRecipe(e) {
            e.preventDefault();
            const newRecipe = { title: document.getElementById('rec-title').value, ingredients: document.getElementById('rec-ings').value, steps: document.getElementById('rec-steps').value };
            const saved = await addRecipeToCloud(newRecipe);
            userRecipes.push(saved);
            closeModal('recipe-modal'); renderCookbook(); e.target.reset();
        }
        function switchTab(t) { currentTab = t; document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); document.getElementById('tab-' + t).classList.add('active'); document.getElementById('content-inventory').classList.toggle('hidden', t !== 'inventory'); document.getElementById('content-cookbook').classList.toggle('hidden', t !== 'cookbook'); }
        function openModal(id) {
            document.getElementById(id).classList.replace('hidden', 'flex');
            if (id === 'settings-modal') {
                const hInput = document.getElementById('settings-household');
                if (hInput) hInput.value = householdId;
            }
        }
        function closeModal(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }

        document.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
            sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('[Mimi] Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–');

            // åŠ è½½æœ¬åœ°è®¾ç½®
            loadLocalSettings();

            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const buyInput = document.getElementById('add-buy');
            const expInput = document.getElementById('add-exp');
            if (buyInput) buyInput.value = new Date().toISOString().split('T')[0];
            if (expInput) expInput.value = new Date(Date.now() + 86400000 * 7).toISOString().split('T')[0];

            // å¡«å…¥è®¾ç½®è¡¨å•
            const apikeyInput = document.getElementById('settings-apikey');
            const modelSelect = document.getElementById('settings-model');
            if (apikeyInput && apiKey) apikeyInput.value = apiKey;
            if (modelSelect && selectedModel) modelSelect.value = selectedModel;

            // ä»äº‘ç«¯åŠ è½½æ•°æ®
            if (householdId) {
                await loadDataFromCloud();
            } else {
                renderAll();
            }

            // æç¤º
            if (!householdId) {
                const speech = document.getElementById('mimi-speech');
                if (speech) speech.innerText = 'æ¬¢è¿ï¼è¯·ç‚¹å‡»ã€Œè®¾ç½®ã€è¾“å…¥å®¶åº­ç å’Œ API Key å¼€å§‹ä½¿ç”¨ã€‚';
            } else if (!apiKey) {
                const speech = document.getElementById('mimi-speech');
                if (speech) speech.innerText = 'æç¤ºï¼šè¯·ç‚¹å‡»ã€Œè®¾ç½®ã€é…ç½® API Key æ¥å¯ç”¨ AI åŠŸèƒ½ï¼';
            }
        });
    </script>
</body>

</html>